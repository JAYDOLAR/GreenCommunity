name: Build and deploy Node.js app to Azure Web App - greencommunity

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: greencommunity-app
  NODE_VERSION: '22.x'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    name: Build and Deploy Application
    runs-on: ubuntu-latest
    timeout-minutes: 20

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            client/package-lock.json
            Server/package-lock.json

      - name: Cache dependencies
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: |
            client/node_modules
            Server/node_modules
            client/.next/cache
          key: deps-${{ runner.os }}-${{ hashFiles('client/package-lock.json', 'Server/package-lock.json') }}
          restore-keys: |
            deps-${{ runner.os }}-

      - name: Install dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          echo "Installing client dependencies..."
          cd client && npm ci --prefer-offline --no-audit --silent &
          CLIENT_PID=$!
          
          echo "Installing server dependencies..."
          cd Server && npm ci --legacy-peer-deps --prefer-offline --no-audit --silent &
          SERVER_PID=$!
          
          wait $CLIENT_PID $SERVER_PID
          echo "Dependencies installed"
        working-directory: ${{ github.workspace }}

      - name: Build Next.js client
        working-directory: ./client
        run: npm run build

      - name: Create deployment package
        run: |
          echo "Creating deployment package..."
          mkdir -p deployment-package/client

          # Copy server files efficiently
          rsync -a --exclude='node_modules' --exclude='.git*' --exclude='tests/' \
            --exclude='__tests__/' --exclude='*.test.*' --exclude='*.spec.*' \
            --exclude='coverage/' --exclude='*.log' --exclude='*.md' \
            Server/ deployment-package/

          # Copy Next.js build and essentials
          cp -r client/.next client/public client/src deployment-package/client/
          cp client/package*.json client/next.config.mjs deployment-package/client/
          [ -f "client/jsconfig.json" ] && cp client/jsconfig.json deployment-package/client/
          [ -f "client/components.json" ] && cp client/components.json deployment-package/client/

          # Copy Azure config
          [ -f "Server/web.config" ] && cp Server/web.config deployment-package/

          # Create startup script
          cat > deployment-package/startup.sh << 'EOF'
          #!/bin/bash
          echo "Starting GreenCommunity application..."
          NODE_ENV=production node server.js
          EOF
          chmod +x deployment-package/startup.sh

      - name: Install production dependencies and optimize
        working-directory: deployment-package
        run: |
          # Install server production deps
          npm ci --omit=dev --legacy-peer-deps --prefer-offline --no-audit --silent
          
          # Install client production deps
          cd client && npm ci --omit=dev --prefer-offline --no-audit --silent && cd ..
          
          # Aggressive cleanup for smaller package
          find . -name "*.map" -type f -delete 2>/dev/null || true
          find . -name "*.md" -type f -delete 2>/dev/null || true
          find . -name "*.test.*" -delete 2>/dev/null || true
          find . -type d -name "test" -path "*/node_modules/*" -exec rm -rf {} + 2>/dev/null || true
          find . -type d -name "tests" -path "*/node_modules/*" -exec rm -rf {} + 2>/dev/null || true
          rm -rf client/.next/cache node_modules/.cache client/node_modules/.cache 2>/dev/null || true
          
          echo "Package size: $(du -sh . | cut -f1)"

      - name: Create ZIP package
        run: |
          cd deployment-package
          zip -r -q ../deployment.zip . -x "*.git*"
          echo "ZIP size: $(du -h ../deployment.zip | cut -f1)"

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Configure and Deploy to Azure
        run: |
          # Configure app settings (runs in background)
          az webapp config appsettings set \
            --resource-group Green_Community \
            --name greencommunity-app \
            --settings \
            SCM_DO_BUILD_DURING_DEPLOYMENT=false \
            WEBSITE_NODE_DEFAULT_VERSION=22.x \
            NODE_ENV=production \
            WEBSITE_RUN_FROM_PACKAGE=1 \
            WEBSITE_ENABLE_SYNC_UPDATE_SITE=true \
            WEBSITES_CONTAINER_START_TIME_LIMIT=1800 \
            --output none &
          CONFIG_PID=$!
          
          az webapp config set \
            --resource-group Green_Community \
            --name greencommunity-app \
            --startup-file "node server.js" \
            --output none &
          STARTUP_PID=$!
          
          wait $CONFIG_PID $STARTUP_PID
          
          # Deploy
          echo "Deploying to Azure..."
          az webapp deploy \
            --resource-group Green_Community \
            --name greencommunity-app \
            --src-path deployment.zip \
            --type zip \
            --async true
          
          echo "Deployment initiated successfully"

      - name: Verify deployment
        run: |
          echo "Waiting for deployment..."
          sleep 30
          
          # Quick health check (3 attempts, 15s apart)
          for i in 1 2 3; do
            if curl -f -s -m 15 "https://greencommunity-app.azurewebsites.net" > /dev/null 2>&1; then
              echo "Application is responding!"
              exit 0
            fi
            [ $i -lt 3 ] && sleep 15
          done
          
          # Check app state as fallback
          STATUS=$(az webapp show --resource-group Green_Community --name greencommunity-app --query "state" -o tsv 2>/dev/null || echo "Unknown")
          echo "App state: $STATUS"
          if [ "$STATUS" = "Running" ]; then
            echo "App is running. May need additional warm-up time."
          fi

      - name: Deployment summary
        if: always()
        run: |
          echo ""
          echo "======================================"
          echo "Deployment Summary"
          echo "======================================"
          echo "App URL: https://greencommunity-app.azurewebsites.net"
          echo ""
          echo "Monitoring:"
          echo "  - Logs: https://greencommunity-app.scm.azurewebsites.net/api/logs/docker"
          echo "  - Stream: https://greencommunity-app.scm.azurewebsites.net/api/logstream"
          echo "======================================"

      - name: Cleanup
        if: always()
        run: rm -rf deployment-package deployment.zip
