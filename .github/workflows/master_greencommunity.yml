name: Build and deploy Node.js app to Azure Web App - greencommunity

on:
  push:
    branches:
      - master
  workflow_dispatch:

# Environment variables for better maintainability
env:
  AZURE_WEBAPP_NAME: Green-community
  NODE_VERSION: '22.x'

# Improved concurrency settings
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest

    permissions:
      contents: read

    outputs:
      artifact-name: ${{ steps.artifact-info.outputs.artifact-name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            client/package-lock.json
            Server/package-lock.json

      - name: Install and build client
        working-directory: ./client
        run: |
          npm ci --prefer-offline --no-audit
          npm run build
          
      - name: Install server dependencies
        working-directory: ./Server
        run: |
          npm ci --legacy-peer-deps --prefer-offline --no-audit

      - name: Run tests (if available)
        run: |
          # Run client tests if they exist
          if [ -f "client/package.json" ] && npm --prefix client run test --if-present; then
            echo "Client tests completed"
          fi
          # Run server tests if they exist
          if [ -f "Server/package.json" ] && npm --prefix Server run test --if-present; then
            echo "Server tests completed"
          fi

      - name: Prepare deployment package
        run: |
          # Create deployment directory
          mkdir -p deployment-package
          
          # Copy server files (excluding node_modules to reduce size)
          rsync -av --exclude='node_modules' --exclude='.git' Server/ deployment-package/
          
          # Copy client build output
          cp -r client/.next deployment-package/.next
          cp -r client/public deployment-package/public
          
          # Copy essential files
          cp client/package*.json deployment-package/ 2>/dev/null || true
          
          # Install production dependencies only in deployment package
          cd deployment-package
          npm ci --only=production --legacy-peer-deps --prefer-offline --no-audit
          cd ..

      - name: Create deployment zip
        run: |
          zip -r deployment-package.zip deployment-package

      - name: Set artifact name
        id: artifact-info
        run: |
          ARTIFACT_NAME="webapp-${{ github.sha }}-$(date +%Y%m%d-%H%M%S)"
          echo "artifact-name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact-info.outputs.artifact-name }}
          path: deployment-package.zip
          retention-days: 30
          compression-level: 6

  deploy:
    name: Deploy to Azure Web App
    runs-on: ubuntu-latest
    needs: build

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Download deployment artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact-name }}
          path: .

      - name: Authenticate to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_590830FF75664EA1BF5D7DF0E9C1963D }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_99406FEA6DE74B5EB356BA1CAD7B1C2D }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_CBE9DEB1A36B4792AE601A767B1BD1C2 }}

      - name: Deploy to Azure Web App
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          slot-name: 'Production'
          package: deployment-package.zip
          startup-command: 'npm start'
          type: zip
          clean: true
          restart: true

      - name: Verify deployment
        run: |
          echo "Deployment completed successfully!"
          echo "Application URL: ${{ steps.deploy-to-webapp.outputs.webapp-url }}"
          
          # Optional: Basic health check
          sleep 30
          if curl -f -s -o /dev/null "${{ steps.deploy-to-webapp.outputs.webapp-url }}"; then
            echo "✅ Health check passed"
          else
            echo "⚠️ Health check failed - app might still be starting"
          fi

  cleanup:
    name: Cleanup old artifacts
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: always()

    permissions:
      actions: write
      contents: read

    steps:
      - name: Cleanup old artifacts
        uses: actions/github-script@v7
        with:
          script: |
            // Keep only the 5 most recent artifacts
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
            });
            
            const sortedArtifacts = artifacts.data.artifacts.sort((a, b) => 
              new Date(b.created_at) - new Date(a.created_at)
            );
            
            for (let i = 5; i < sortedArtifacts.length; i++) {
              try {
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: sortedArtifacts[i].id,
                });
                console.log(`Deleted artifact: ${sortedArtifacts[i].name}`);
              } catch (error) {
                console.log(`Failed to delete artifact: ${error.message}`);
              }
            }