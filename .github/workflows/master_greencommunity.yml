name: Build and deploy Node.js app to Azure Web App - greencommunity

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: Green-community
  NODE_VERSION: '22.x'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    name: Build and Deploy Application
    runs-on: ubuntu-latest
    timeout-minutes: 35

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            client/package-lock.json
            Server/package-lock.json

      - name: Cache Next.js build
        uses: actions/cache@v4
        with:
          path: |
            client/.next/cache
            client/node_modules
            Server/node_modules
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('client/src/**/*', 'Server/**/*') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-
            ${{ runner.os }}-nextjs-

      - name: Install client dependencies
        working-directory: ./client
        run: |
          npm ci --prefer-offline --no-audit --silent
          
      - name: Install server dependencies
        working-directory: ./Server
        run: |
          npm ci --legacy-peer-deps --prefer-offline --no-audit --silent

      - name: Build Next.js client
        working-directory: ./client
        run: |
          npm run build

      - name: Run tests (if available)
        env:
          GOOGLE_CLIENT_ID: "test-client-id"
          GOOGLE_CLIENT_SECRET: "test-secret"
          GOOGLE_CALLBACK: "http://localhost/callback"
          NODE_ENV: test
        run: |
          if [ -f "client/package.json" ] && npm --prefix client run test --if-present --passWithNoTests; then
            echo "Client tests completed"
          fi
          if [ -f "Server/package.json" ] && npm --prefix Server run test --if-present --passWithNoTests; then
            echo "Server tests completed"
          fi

      - name: Create optimized deployment package
        run: |
          echo "Creating deployment package..."
          mkdir -p deployment-package

          # Copy server files (exclude unnecessary files upfront)
          echo "Copying server files..."
          rsync -av \
            --exclude='node_modules' \
            --exclude='.git*' \
            --exclude='tests/' \
            --exclude='__tests__/' \
            --exclude='*.test.*' \
            --exclude='*.spec.*' \
            --exclude='docs/' \
            --exclude='.github/' \
            --exclude='coverage/' \
            --exclude='.nyc_output/' \
            --exclude='*.log' \
            Server/ deployment-package/

          # Create minimal Next.js deployment structure
          echo "Setting up Next.js structure..."
          mkdir -p deployment-package/client
          
          # Copy only essential Next.js files
          cp -r client/.next deployment-package/client/
          cp -r client/public deployment-package/client/
          cp client/package*.json deployment-package/client/
          
          # Copy source files for Next.js runtime (needed for production)
          cp -r client/src deployment-package/client/
          
          # Copy config files only if they exist
          [ -f "client/next.config.mjs" ] && cp client/next.config.mjs deployment-package/client/
          [ -f "client/jsconfig.json" ] && cp client/jsconfig.json deployment-package/client/
          [ -f "client/postcss.config.mjs" ] && cp client/postcss.config.mjs deployment-package/client/
          [ -f "client/tailwind.config.js" ] && cp client/tailwind.config.js deployment-package/client/
          [ -f "client/components.json" ] && cp client/components.json deployment-package/client/
          
          # Copy root package.json
          cp Server/package*.json deployment-package/
          
          # Copy Azure-specific files if they exist
          [ -f "Server/web.config" ] && cp Server/web.config deployment-package/
          [ -f "Server/startup.sh" ] && cp Server/startup.sh deployment-package/ && chmod +x deployment-package/startup.sh
          
          # Create a custom startup script for Azure
          cat > deployment-package/startup.sh << 'EOF'
          #!/bin/bash
          echo "Starting GreenCommunity application..."
          echo "Current directory: $(pwd)"
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          
          # Check if server.js exists
          if [ -f "server.js" ]; then
            echo "Found server.js, starting application..."
            NODE_ENV=production node server.js
          elif [ -f "app.js" ]; then
            echo "Found app.js, starting application..."
            NODE_ENV=production node app.js
          else
            echo "ERROR: No entry point found!"
            ls -la
            exit 1
          fi
          EOF
          
          chmod +x deployment-package/startup.sh
          
          echo "Package structure created"

      - name: Install production dependencies
        working-directory: deployment-package
        run: |
          echo "Installing server production dependencies..."
          npm ci --omit=dev --legacy-peer-deps --prefer-offline --no-audit --silent
          
          echo "Installing client production dependencies..."
          cd client
          npm ci --omit=dev --prefer-offline --no-audit --silent
          cd ..
          
          # Clean up unnecessary files
          echo "Cleaning up unnecessary files..."
          find . -name "*.test.*" -delete 2>/dev/null || true
          find . -name "*.spec.*" -delete 2>/dev/null || true
          find . -type d -name "__tests__" -exec rm -rf {} + 2>/dev/null || true
          find . -type d -name "coverage" -exec rm -rf {} + 2>/dev/null || true
          find . -name "*.md" -delete 2>/dev/null || true
          find . -name ".git*" -delete 2>/dev/null || true
          find . -name "*.log" -delete 2>/dev/null || true

      - name: Optimize deployment package
        working-directory: deployment-package
        run: |
          echo "Optimizing package size..."
          
          # Remove caches
          rm -rf client/node_modules/.cache 2>/dev/null || true
          rm -rf node_modules/.cache 2>/dev/null || true
          rm -rf client/.next/cache 2>/dev/null || true
          
          # Remove source maps (optional - comment out if you need them for debugging)
          find . -name "*.map" -type f -delete 2>/dev/null || true
          
          # Remove unnecessary node_modules subdirectories
          find . -type d -name ".bin" -path "*/node_modules/*" -exec rm -rf {} + 2>/dev/null || true
          find . -type d -name "test" -path "*/node_modules/*" -exec rm -rf {} + 2>/dev/null || true
          find . -type d -name "tests" -path "*/node_modules/*" -exec rm -rf {} + 2>/dev/null || true
          
          echo "Final package size:"
          du -sh .

      - name: Create ZIP deployment package
        run: |
          echo "Creating ZIP archive for faster upload..."
          cd deployment-package
          zip -r -q ../deployment.zip . -x "*.git*"
          cd ..
          echo "ZIP size: $(du -h deployment.zip | cut -f1)"

      - name: Verify deployment structure
        working-directory: deployment-package
        run: |
          echo "ðŸ“¦ Deployment package contents:"
          ls -la
          echo ""
          echo "ðŸ“„ Package.json files found:"
          find . -name "package.json" -type f -exec echo "  - {}" \;
          echo ""
          if [ -d "client" ]; then
            echo "âœ… Client directory exists"
            echo "ðŸ“ Client contents:"
            ls -la client/ | head -10
          else
            echo "âŒ Client directory missing"
          fi

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_590830FF75664EA1BF5D7DF0E9C1963D }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_99406FEA6DE74B5EB356BA1CAD7B1C2D }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_CBE9DEB1A36B4792AE601A767B1BD1C2 }}

      - name: Configure Azure App Service settings
        run: |
          echo "Configuring app settings..."
          az webapp config appsettings set \
            --resource-group Green_Community \
            --name Green-community \
            --settings \
            SCM_DO_BUILD_DURING_DEPLOYMENT=false \
            WEBSITE_NODE_DEFAULT_VERSION=22.x \
            NODE_ENV=production \
            WEBSITE_RUN_FROM_PACKAGE=1 \
            WEBSITE_ENABLE_SYNC_UPDATE_SITE=true \
            WEBSITES_CONTAINER_START_TIME_LIMIT=1800 \
            WEBSITE_TIME_ZONE="Asia/Kolkata" \
            --output none
          
          echo "Configuring startup command..."
          az webapp config set \
            --resource-group Green_Community \
            --name Green-community \
            --startup-file "node server.js" \
            --output none

      - name: Deploy using Azure CLI (ZIP Deploy)
        run: |
          echo "Starting ZIP deployment to Azure..."
          echo "â±ï¸  Deploying package..."
          
          # Use async deployment to avoid timeout during startup
          DEPLOY_OUTPUT=$(az webapp deploy \
            --resource-group Green_Community \
            --name Green-community \
            --src-path deployment.zip \
            --type zip \
            --async true 2>&1)
          
          echo "$DEPLOY_OUTPUT"
          
          if echo "$DEPLOY_OUTPUT" | grep -q "ERROR"; then
            echo "âŒ Deployment failed"
            exit 1
          fi
          
          echo "âœ… Deployment package uploaded successfully"
          echo "ðŸ“¦ Azure is now extracting and starting the application..."
          echo "â±ï¸  This may take 5-15 minutes for large applications"

      - name: Wait for deployment to extract
        run: |
          echo "Waiting for Azure to extract and prepare the package..."
          sleep 60
          
          echo "Checking deployment status..."
          for i in {1..5}; do
            STATUS=$(az webapp show \
              --resource-group Green_Community \
              --name Green-community \
              --query "state" -o tsv 2>/dev/null || echo "Unknown")
            
            echo "Attempt $i/5 - App state: $STATUS"
            
            if [ "$STATUS" = "Running" ]; then
              echo "âœ… App is in Running state"
              break
            fi
            
            if [ $i -lt 5 ]; then
              echo "â³ Waiting 30 seconds..."
              sleep 30
            fi
          done

      - name: Warm up application
        run: |
          echo "Checking if application is responding..."
          max_attempts=10
          for i in $(seq 1 $max_attempts); do
            echo "Attempt $i/$max_attempts:"
            if curl -f -s -m 30 "https://www.green-community.app" > /dev/null 2>&1; then
              echo "âœ… Application is responding!"
              exit 0
            else
              echo "â³ Not ready yet, waiting 30 seconds..."
              if [ $i -lt $max_attempts ]; then
                sleep 30
              fi
            fi
          done
          echo "âš ï¸ Application taking longer than expected to start"
          echo "ðŸ’¡ This is normal for large applications. Check manually in a few minutes."

      - name: Final status
        if: always()
        run: |
          echo ""
          echo "======================================"
          echo "ðŸ“Š Deployment Summary"
          echo "======================================"
          echo "âœ… Package built and uploaded successfully"
          echo "ðŸŒ App URL: https://www.green-community.app"
          echo "ðŸŒ Azure URL: https://green-community.azurewebsites.net"
          echo ""
          echo "ðŸ“‹ Monitoring URLs:"
          echo "  - Deployments: https://green-community.scm.azurewebsites.net/api/deployments"
          echo "  - Logs: https://green-community.scm.azurewebsites.net/api/logs/docker"
          echo "  - Log Stream: https://green-community.scm.azurewebsites.net/api/logstream"
          echo ""
          echo "ðŸ’¡ If app is not responding yet:"
          echo "  1. Large apps can take 10-15 minutes to start"
          echo "  2. Check the logs above for any errors"
          echo "  3. Verify all environment variables are set in Azure Portal"
          echo "======================================"
          
      - name: Check application logs for errors
        if: failure()
        run: |
          echo "Fetching recent application logs..."
          az webapp log download \
            --resource-group Green_Community \
            --name Green-community \
            --log-file app-logs.zip 2>/dev/null || true
          
          echo ""
          echo "ðŸ“‹ Check logs at:"
          echo "  - https://green-community.scm.azurewebsites.net/api/logs/docker"

      - name: Cleanup workspace
        if: always()
        run: |
          echo "Cleaning up..."
          rm -rf deployment-package
          rm -f deployment.zip
          echo "âœ… Cleanup complete"
