name: Build and deploy Node.js app to Azure Web App - greencommunity

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: Green-community
  NODE_VERSION: '22.x'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            client/package-lock.json
            Server/package-lock.json

      - name: Cache Next.js build
        uses: actions/cache@v4
        with:
          path: client/.next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('client/package-lock.json') }}-${{ hashFiles('client/src/**.[jt]s', 'client/src/**.[jt]sx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('client/package-lock.json') }}-

      - name: Install and build client
        working-directory: ./client
        run: |
          npm ci --prefer-offline --no-audit
          npm run build
          
      - name: Install server dependencies
        working-directory: ./Server
        run: |
          npm ci --legacy-peer-deps --prefer-offline --no-audit

      - name: Run tests (if available)
        run: |
          if [ -f "client/package.json" ] && npm --prefix client run test --if-present; then
            echo "Client tests completed"
          fi
          if [ -f "Server/package.json" ] && npm --prefix Server run test --if-present; then
            echo "Server tests completed"
          fi

      - name: Prepare deployment package
        run: |
          mkdir -p deployment-package

          # Copy server files to root (exclude dev-only stuff)
          rsync -av \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='tests' \
            --exclude='__tests__' \
            --exclude='*.test.*' \
            --exclude='docs' \
            --exclude='.github' \
            Server/ deployment-package/

          # Create client directory structure for Next.js
          mkdir -p deployment-package/client
          
          # Copy complete client build with proper structure
          cp -r client/.next deployment-package/client/.next
          cp -r client/public deployment-package/client/public
          cp client/next.config.mjs deployment-package/client/next.config.mjs
          cp client/package*.json deployment-package/client/
          
          # Copy ALL client source files needed for Next.js runtime
          cp -r client/src deployment-package/client/src
          
          # Copy additional Next.js config files if they exist
          if [ -f "client/jsconfig.json" ]; then
            cp client/jsconfig.json deployment-package/client/jsconfig.json
          fi
          if [ -f "client/components.json" ]; then
            cp client/components.json deployment-package/client/components.json
          fi
          if [ -f "client/postcss.config.mjs" ]; then
            cp client/postcss.config.mjs deployment-package/client/postcss.config.mjs
          fi
          if [ -f "client/tailwind.config.js" ]; then
            cp client/tailwind.config.js deployment-package/client/tailwind.config.js
          fi
          
          # Copy root package.json for server
          cp Server/package*.json deployment-package/
          
          # Copy deployment-specific package.json to root
          if [ -f "Server/deployment-package.json" ]; then
            cp Server/deployment-package.json deployment-package/package.json
          fi
          
          # Copy web.config for Azure App Service
          if [ -f "Server/web.config" ]; then
            cp Server/web.config deployment-package/web.config
          fi
          
          # Copy startup script for Azure App Service
          if [ -f "Server/startup.sh" ]; then
            cp Server/startup.sh deployment-package/startup.sh
            chmod +x deployment-package/startup.sh
          fi

          # Install only production dependencies for server
          cd deployment-package
          npm ci --only=production --legacy-peer-deps --prefer-offline --no-audit
          
          # Install client dependencies for Next.js runtime (only production)
          cd client
          npm ci --only=production --prefer-offline --no-audit
          
          # Remove unnecessary files to reduce package size
          find . -name "*.test.*" -type f -delete
          find . -name "__tests__" -type d -exec rm -rf {} + 2>/dev/null || true
          find . -name "*.md" -type f -delete 2>/dev/null || true
          find . -name ".git*" -exec rm -rf {} + 2>/dev/null || true
          
          cd ../..

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: node-app   # ğŸ‘ˆ must match the deploy job
          path: deployment-package/
          retention-days: 30
          compression-level: 6

  deploy:
    name: Deploy to Azure Web App
    runs-on: ubuntu-latest
    needs: build

    permissions:
      id-token: write   # Required for requesting the JWT
      contents: read    # Required for actions/checkout

    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: node-app
          path: .

      - name: Verify deployment package structure
        run: |
          echo "ğŸ“¦ Deployment package contents:"
          ls -la
          echo ""
          echo "ğŸ“ Client directory structure:"
          if [ -d "client" ]; then
            ls -la client/
            echo ""
            echo "ğŸ“ Client src structure:"
            if [ -d "client/src" ]; then
              ls -la client/src/
            else
              echo "âŒ client/src directory not found"
            fi
          else
            echo "âŒ client directory not found"
          fi
          echo ""
          echo "ğŸ“„ Package.json files:"
          find . -name "package.json" -type f

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_590830FF75664EA1BF5D7DF0E9C1963D }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_99406FEA6DE74B5EB356BA1CAD7B1C2D }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_CBE9DEB1A36B4792AE601A767B1BD1C2 }}

      - name: Clear Azure App Service cache
        run: |
          echo "ğŸ§¹ Clearing Azure App Service cache to prevent SCM restart conflicts..."
          az webapp restart --name Green-community --resource-group Green_Community
          echo "â³ Waiting for service to stabilize..."
          sleep 15

      - name: Deploy to Azure Web App (Attempt 1)
        id: deploy-to-webapp-1
        uses: azure/webapps-deploy@v3
        with:
          app-name: Green-community
          package: .
        continue-on-error: true

      - name: Wait before retry
        if: steps.deploy-to-webapp-1.outcome == 'failure'
        run: |
          echo "First deployment failed, waiting 30 seconds before retry..."
          sleep 30

      - name: Deploy to Azure Web App (Attempt 2)
        id: deploy-to-webapp-2
        if: steps.deploy-to-webapp-1.outcome == 'failure'
        uses: azure/webapps-deploy@v3
        with:
          app-name: Green-community
          package: .
        continue-on-error: true

      - name: Final deployment status
        if: always()
        run: |
          if [ "${{ steps.deploy-to-webapp-1.outcome }}" == "success" ]; then
            echo "âœ… Deployment succeeded on first attempt"
            exit 0
          elif [ "${{ steps.deploy-to-webapp-2.outcome }}" == "success" ]; then
            echo "âœ… Deployment succeeded on second attempt"
            exit 0
          else
            echo "âŒ Both deployment attempts failed"
            exit 1
          fi

      - name: Alternative deployment method
        if: failure()
        run: |
          echo "Primary deployment failed, trying alternative method..."
          # Create a simple zip for manual deployment
          zip -r deployment.zip . -x "*.git*" "node_modules/*" ".github/*"
          echo "Alternative deployment package created: deployment.zip"
          echo "Manual deployment may be required."

      - name: Verify deployment
        if: steps.deploy-to-webapp-1.outcome == 'success' || steps.deploy-to-webapp-2.outcome == 'success'
        run: |
          echo "Deployment completed successfully!"
          echo "Application URL: https://green-community.azurewebsites.net"
          sleep 30
          if curl -f -s -o /dev/null "https://green-community.azurewebsites.net"; then
            echo "âœ… Health check passed"
          else
            echo "âš ï¸ Health check failed - app might still be starting"
          fi

  cleanup:
    name: Cleanup old artifacts
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: always()

    permissions:
      actions: write
      contents: read

    steps:
      - name: Cleanup old artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
            });
            const sortedArtifacts = artifacts.data.artifacts.sort((a, b) => 
              new Date(b.created_at) - new Date(a.created_at)
            );
            for (let i = 5; i < sortedArtifacts.length; i++) {
              try {
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: sortedArtifacts[i].id,
                });
                console.log(`Deleted artifact: ${sortedArtifacts[i].name}`);
              } catch (error) {
                console.log(`Failed to delete artifact: ${error.message}`);
              }
            }
